# Email System and DNS Setup Guide

## Overview

This guide covers setting up a complete email system for the AI Chat System, including custom domain emails for VIP+ members, DNS configuration, and an integrated webmail client.

## üèóÔ∏è Email System Architecture

### Components
- **Mail Server**: Postfix (SMTP) + Dovecot (IMAP/POP3)
- **Webmail Client**: Roundcube or custom React-based client
- **Anti-Spam**: SpamAssassin + ClamAV
- **Database**: PostgreSQL for email accounts and settings
- **SSL/TLS**: Let's Encrypt certificates for secure email

### Email Features by Tier
- **Guest/Free**: No email access
- **VIP**: Custom email address (username@yourdomain.com)
- **Paid**: Custom email + 5GB storage + advanced features
- **Business**: Custom email + 50GB storage + admin features + aliases

## üåê DNS Configuration

### Required DNS Records

#### MX Records (Mail Exchange)
```dns
# Primary mail server
yourdomain.com.     IN  MX  10  mail.yourdomain.com.

# Backup mail server (optional)
yourdomain.com.     IN  MX  20  mail2.yourdomain.com.
```

#### A Records
```dns
# Mail server
mail.yourdomain.com.        IN  A   YOUR_SERVER_IP
mail2.yourdomain.com.       IN  A   YOUR_BACKUP_IP

# Webmail interface
webmail.yourdomain.com.     IN  A   YOUR_SERVER_IP
```

#### SPF Record (Sender Policy Framework)
```dns
yourdomain.com.     IN  TXT  "v=spf1 mx a:mail.yourdomain.com ip4:YOUR_SERVER_IP ~all"
```

#### DKIM Record (DomainKeys Identified Mail)
```dns
# Generated by your mail server
default._domainkey.yourdomain.com.  IN  TXT  "v=DKIM1; k=rsa; p=YOUR_PUBLIC_KEY"
```

#### DMARC Record (Domain-based Message Authentication)
```dns
_dmarc.yourdomain.com.  IN  TXT  "v=DMARC1; p=quarantine; rua=mailto:dmarc@yourdomain.com"
```

#### PTR Record (Reverse DNS)
```dns
# Set with your hosting provider
YOUR_SERVER_IP  IN  PTR  mail.yourdomain.com.
```

### DNS Provider Configuration Examples

#### Cloudflare
```bash
# Add via Cloudflare Dashboard or API
curl -X POST "https://api.cloudflare.com/client/v4/zones/ZONE_ID/dns_records" \
  -H "Authorization: Bearer YOUR_API_TOKEN" \
  -H "Content-Type: application/json" \
  --data '{
    "type": "MX",
    "name": "yourdomain.com",
    "content": "mail.yourdomain.com",
    "priority": 10
  }'
```

#### AWS Route 53
```json
{
  "Changes": [{
    "Action": "CREATE",
    "ResourceRecordSet": {
      "Name": "yourdomain.com",
      "Type": "MX",
      "TTL": 300,
      "ResourceRecords": [{"Value": "10 mail.yourdomain.com"}]
    }
  }]
}
```

## üîß Server Configuration

### Required Ports
```bash
# SMTP (Simple Mail Transfer Protocol)
Port 25   - SMTP (unencrypted) - Usually blocked by ISPs
Port 587  - SMTP Submission (STARTTLS) - Recommended
Port 465  - SMTPS (SSL/TLS) - Legacy but still used

# IMAP (Internet Message Access Protocol)
Port 143  - IMAP (unencrypted)
Port 993  - IMAPS (SSL/TLS) - Recommended

# POP3 (Post Office Protocol)
Port 110  - POP3 (unencrypted)
Port 995  - POP3S (SSL/TLS)

# HTTP/HTTPS for webmail
Port 80   - HTTP (redirect to HTTPS)
Port 443  - HTTPS - Webmail interface
```

### Firewall Configuration (UFW)
```bash
# Allow email ports
sudo ufw allow 587/tcp   # SMTP Submission
sudo ufw allow 465/tcp   # SMTPS
sudo ufw allow 993/tcp   # IMAPS
sudo ufw allow 995/tcp   # POP3S
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS

# Optional: Allow IMAP/POP3 unencrypted (not recommended)
# sudo ufw allow 143/tcp   # IMAP
# sudo ufw allow 110/tcp   # POP3
```

### Postfix Configuration (/etc/postfix/main.cf)
```bash
# Basic configuration
myhostname = mail.yourdomain.com
mydomain = yourdomain.com
myorigin = $mydomain
inet_interfaces = all
mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain

# Virtual domains and users
virtual_mailbox_domains = yourdomain.com
virtual_mailbox_base = /var/mail/vhosts
virtual_mailbox_maps = pgsql:/etc/postfix/pgsql-virtual-mailbox-maps.cf
virtual_alias_maps = pgsql:/etc/postfix/pgsql-virtual-alias-maps.cf
virtual_uid_maps = static:5000
virtual_gid_maps = static:5000

# TLS/SSL configuration
smtpd_tls_cert_file = /etc/letsencrypt/live/mail.yourdomain.com/fullchain.pem
smtpd_tls_key_file = /etc/letsencrypt/live/mail.yourdomain.com/privkey.pem
smtpd_use_tls = yes
smtpd_tls_security_level = may
smtp_tls_security_level = may

# SASL authentication
smtpd_sasl_type = dovecot
smtpd_sasl_path = private/auth
smtpd_sasl_auth_enable = yes
```

### Dovecot Configuration (/etc/dovecot/dovecot.conf)
```bash
# Protocols
protocols = imap pop3 lmtp

# SSL configuration
ssl = required
ssl_cert = </etc/letsencrypt/live/mail.yourdomain.com/fullchain.pem
ssl_key = </etc/letsencrypt/live/mail.yourdomain.com/privkey.pem

# Authentication
auth_mechanisms = plain login
passdb {
  driver = sql
  args = /etc/dovecot/dovecot-sql.conf.ext
}
userdb {
  driver = sql
  args = /etc/dovecot/dovecot-sql.conf.ext
}

# Mail location
mail_location = maildir:/var/mail/vhosts/%d/%n
```

## üìß Database Schema for Email System

### Email Accounts Table
```sql
CREATE TABLE email_accounts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    email_address VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    quota_bytes BIGINT DEFAULT 0,
    used_bytes BIGINT DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    last_login TIMESTAMP,
    settings JSONB DEFAULT '{}'
);
```

### Email Aliases Table
```sql
CREATE TABLE email_aliases (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    alias_address VARCHAR(255) UNIQUE NOT NULL,
    destination_address VARCHAR(255) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### Email Folders Table
```sql
CREATE TABLE email_folders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email_account_id UUID REFERENCES email_accounts(id),
    folder_name VARCHAR(100) NOT NULL,
    folder_type VARCHAR(20) DEFAULT 'custom', -- inbox, sent, drafts, trash, custom
    parent_folder_id UUID REFERENCES email_folders(id),
    created_at TIMESTAMP DEFAULT NOW()
);
```

## üîê Security Configuration

### SSL/TLS Certificate Setup (Let's Encrypt)
```bash
# Install Certbot
sudo apt install certbot

# Get certificate for mail server
sudo certbot certonly --standalone -d mail.yourdomain.com -d webmail.yourdomain.com

# Auto-renewal cron job
echo "0 12 * * * /usr/bin/certbot renew --quiet" | sudo crontab -
```

### DKIM Setup
```bash
# Install OpenDKIM
sudo apt install opendkim opendkim-tools

# Generate DKIM keys
sudo opendkim-genkey -t -s default -d yourdomain.com

# Add to DNS
cat /etc/opendkim/keys/yourdomain.com/default.txt
```

### Anti-Spam Configuration
```bash
# Install SpamAssassin
sudo apt install spamassassin spamc

# Configure Postfix to use SpamAssassin
# Add to /etc/postfix/master.cf:
smtp      inet  n       -       y       -       -       smtpd
  -o content_filter=spamassassin

spamassassin unix -     n       n       -       -       pipe
  user=spamd argv=/usr/bin/spamc -f -e /usr/sbin/sendmail -oi -f ${sender} ${recipient}
```

## üåê Webmail Client Integration

### Option 1: Roundcube (PHP-based)
```bash
# Install Roundcube
sudo apt install roundcube roundcube-mysql

# Configure Apache/Nginx virtual host
server {
    listen 443 ssl;
    server_name webmail.yourdomain.com;
    
    ssl_certificate /etc/letsencrypt/live/webmail.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/webmail.yourdomain.com/privkey.pem;
    
    root /var/lib/roundcube;
    index index.php;
    
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
        fastcgi_index index.php;
        include fastcgi_params;
    }
}
```

### Option 2: Custom React-based Webmail
```javascript
// Email client components
- EmailList component
- EmailComposer component
- EmailViewer component
- FolderTree component
- SearchInterface component
```

## üîß Integration with AI Chat System

### User Tier Email Quotas
```python
TIER_EMAIL_QUOTAS = {
    'guest': 0,           # No email
    'free': 0,            # No email
    'vip': 1024**3,       # 1GB
    'paid': 5 * 1024**3,  # 5GB
    'business': 50 * 1024**3  # 50GB
}
```

### Email Account Creation API
```python
@app.post("/api/email/create")
async def create_email_account(
    username: str,
    user: User = Depends(get_current_user)
):
    # Check if user tier allows email
    if user.tier in ['guest', 'free']:
        raise HTTPException(403, "Email requires VIP tier or higher")
    
    # Create email account
    email_address = f"{username}@yourdomain.com"
    # ... implementation
```

## üì± Mobile Email Configuration

### IMAP Settings for Email Clients
```
Server: mail.yourdomain.com
Port: 993
Security: SSL/TLS
Username: user@yourdomain.com
Password: [user's email password]
```

### SMTP Settings for Sending
```
Server: mail.yourdomain.com
Port: 587
Security: STARTTLS
Username: user@yourdomain.com
Password: [user's email password]
```

## üîç Monitoring and Maintenance

### Log Files to Monitor
```bash
# Postfix logs
/var/log/mail.log
/var/log/mail.err

# Dovecot logs
/var/log/dovecot.log

# Apache/Nginx logs
/var/log/apache2/access.log
/var/log/nginx/access.log
```

### Email Queue Management
```bash
# View mail queue
sudo postqueue -p

# Flush mail queue
sudo postqueue -f

# Delete specific message
sudo postsuper -d MESSAGE_ID
```

### Backup Strategy
```bash
# Backup email data
rsync -av /var/mail/vhosts/ /backup/email/

# Backup email database
pg_dump email_system > /backup/email_db.sql

# Backup configuration
tar -czf /backup/email_config.tar.gz /etc/postfix /etc/dovecot
```

## üöÄ Deployment Checklist

### Pre-deployment
- [ ] DNS records configured and propagated
- [ ] SSL certificates obtained and installed
- [ ] Firewall rules configured
- [ ] Mail server software installed and configured
- [ ] Database schema created
- [ ] Anti-spam and security measures configured

### Post-deployment Testing
- [ ] Send test email from external provider
- [ ] Receive test email to custom domain
- [ ] Test webmail login and functionality
- [ ] Verify DKIM, SPF, and DMARC records
- [ ] Test email client configuration (IMAP/SMTP)
- [ ] Monitor logs for errors

### Ongoing Maintenance
- [ ] Monitor email delivery rates
- [ ] Update spam filters regularly
- [ ] Renew SSL certificates automatically
- [ ] Monitor disk usage for email storage
- [ ] Regular security updates
- [ ] Backup email data and configurations

This comprehensive email system provides VIP+ members with professional email addresses while maintaining security, deliverability, and integration with the AI Chat System's user tier structure.