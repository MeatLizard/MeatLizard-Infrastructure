# Transcript Format & Flow

This document details the structure of the chat transcripts generated by the system and the process by which they are delivered to users.

## 1. Transcript Generation

-   **Trigger**: Transcripts are generated when a user or admin executes the `/ai end` command in a session channel.
-   **Process**:
    1.  The `server-bot` marks the session as "archiving" in the database.
    2.  A background task (e.g., a Celery worker) is initiated.
    3.  The worker queries the database for all messages associated with the `session_id`.
    4.  The messages are ordered by timestamp.
    5.  The worker formats the data into both JSON and CSV formats.
    6.  The formatted files are uploaded to the configured S3 bucket under a path like `transcripts/{session_id}/transcript.json`.
    7.  A record of the transcript is saved to the `transcripts` table in the database, including the S3 path.

## 2. Transcript Formats

The system generates transcripts in two formats to support both human readability (CSV) and machine processing (JSON).

### 2.1. JSON Format (`transcript.json`)

The JSON format is a structured representation of the entire session, including metadata.

```json
{
  "session_id": "sess_a1b2c3d4e5f67890",
  "user_id": "usr_discord_123456789",
  "username": "Alice",
  "discord_channel_id": "112233445566778899",
  "start_time_utc": "2025-09-16T18:30:00Z",
  "end_time_utc": "2025-09-16T19:15:22Z",
  "system_prompt": "You are a helpful assistant.",
  "model_parameters_used": {
    "model_alias": "vicuna-13b-v1.5",
    "temperature": 0.8
  },
  "message_count": 4,
  "messages": [
    {
      "message_id": "msg_1",
      "timestamp_utc": "2025-09-16T18:30:05Z",
      "sender": "user",
      "content": "Hello, who are you?"
    },
    {
      "message_id": "msg_2",
      "timestamp_utc": "2025-09-16T18:30:10Z",
      "sender": "ai",
      "content": "I am a large language model. How can I help you today?"
    },
    {
      "message_id": "msg_3",
      "timestamp_utc": "2025-09-16T18:32:45Z",
      "sender": "user",
      "content": "What is the capital of France?"
    },
    {
      "message_id": "msg_4",
      "timestamp_utc": "2025-09-16T18:32:50Z",
      "sender": "ai",
      "content": "The capital of France is Paris."
    }
  ]
}
```

### 2.2. CSV Format (`transcript.csv`)

The CSV format is optimized for easy viewing in spreadsheet software.

```csv
timestamp_utc,sender,content
"2025-09-16T18:30:05Z","user","Hello, who are you?"
"2025-09-16T18:30:10Z","ai","I am a large language model. How can I help you today?"
"2025-09-16T18:32:45Z","user","What is the capital of France?"
"2025-09-16T18:32:50Z","ai","The capital of France is Paris."
```

## 3. Delivery to User (DM Flow)

-   **Privacy First**: Transcripts are private by default. The user who initiated the session is the only one who receives a direct link.
-   **Process**:
    1.  Once the transcript files are successfully uploaded to S3, the background worker generates a pre-signed URL for the JSON file.
    2.  Pre-signed URLs provide temporary, secure access to a private S3 object without needing to make the object public. The URL is typically configured to expire after a set period (e.g., 24 hours).
    3.  The `server-bot` sends a Direct Message (DM) to the Discord user who started the session.
    4.  The DM contains a confirmation message and the secure link.

### Example DM Content

> **Subject: Your AI Chat Transcript is Ready**
>
> Hello Alice,
>
> The transcript for your AI session (`#ai-session-alice-123`) is complete.
>
> You can download it using the secure link below. This link will expire in 24 hours.
>
> [**Download Transcript (JSON)**](https://your-s3-bucket.s3.amazonaws.com/transcripts/sess_a1b2c3d4e5f67890/transcript.json?AWSAccessKeyId=...&Expires=...&Signature=...)
>
> The session channel has now been archived. You can start a new conversation at any time with the `/ai start` command.

## 4. Admin Access

-   In addition to the user DM, a message is posted to the private admin-only `#ai-transcripts` channel.
-   This message includes the session ID, the user, and a permanent link (not pre-signed) to the transcript files in S3 for administrative and archival purposes.
