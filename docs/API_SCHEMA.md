# API & Message Schema

This document defines the JSON schemas used for communication between the various components of the MeatLizard AI Platform.

## 1. Web UI -> FastAPI (WebSocket)

This is the primary schema for sending a new prompt from the web interface to the backend.

**Request:**
```json
{
  "prompt": "string"
}
```
-   `prompt`: The user's message.

**Response (Streamed):**
The response is a stream of text chunks sent over the WebSocket as they are generated by the AI.

## 2. FastAPI <-> Server-Bot (Internal Queues)

These schemas are used for the internal `asyncio.Queue` communication between the web server process and the Discord bot process.

### 2.1. Request Queue (Web -> Bot)

**Create Session Message:**
```json
{
  "action": "create_session",
  "session_id": "string (uuid)"
}
```

**Send Message Message:**
```json
{
  "action": "send_message",
  "session_id": "string (uuid)",
  "prompt": "bytes (encrypted)"
}
```

### 2.2. Response Queue (Bot -> Web)

The response queue for each session contains the decrypted, plain-text response chunks from the AI.

**Response Chunk:**
```
"string"
```

## 3. Server-Bot <-> Client-Bot (Discord Payloads)

All messages sent between the bots over Discord are **encrypted** using the `PAYLOAD_ENCRYPTION_KEY`. The decrypted payload follows these schemas.

**Request (Server -> Client):**
```json
{
  "session_id": "string (uuid)",
  "request_id": "string (uuid)",
  "prompt": "string",
  "system_prompt": "string (optional)",
  "temperature": "float (optional)"
}
```

**Response (Client -> Server):**
```json
{
  "session_id": "string (uuid)",
  "request_id": "string (uuid)",
  "response": "string",
  "metrics": {
    "tokens_per_second": "float"
  }
}
```

**Error Response (Client -> Server):**
```json
{
  "session_id": "string (uuid)",
  "request_id": "string (uuid)",
  "error_message": "string"
}
```

## 4. Client-Bot -> Server-Bot (Metrics)

Metrics are sent periodically from the client to the `#ai-metrics` channel. The payload is an encrypted JSON string following the `ClientBotMetrics` schema.

**Decrypted Metrics Payload:**
```json
{
  "timestamp": "string (datetime isoformat)",
  "gpu_stats": {
    "utilization": "float",
    "memory_free": "float",
    "memory_used": "float",
    "temperature": "float"
  },
  "tokens_per_second": "float",
  "is_online": "boolean"
}
```